## Отчёт

Запустить трейн можно через 
```bash
python main.py
```
собственно, и всё, боже, как же просто. Конфиг лежит в `config.yaml`, можно что-то покрутить, можно что-то дописать (но осторожно). Тесты можно запустить через 
```bash
pytest tests
```
На цпу может работать долго даже с урезанным семплом, хз почему правда.
Собственно я вообще всё в ноутбуке делал, потому что мне тупа лень, но должно работать и из терминала

### 1. Тесты

Я в принципе пометил всё, что вызвало у меня сомнения, сразу в модулях, там есть немного комментов.
Ключевое, что я пробовал:

- Первое, что я прошёл сразу же чекать, это тесты модели. Они заваливались где-то в промежутке, я отследил, что дело в юнете, поэтому решил внимательно посмотреть на него. Я заметил, что код там довольно всратый, поэтому решил, что дело просто в том, что архитектура там вообще не так, как в статье, и надо бы её переделать (зря). В итоге я это сделал, 4 down слоя с 2 свёртками с паддингом, чтобы аутпут был такой же размерности, 4 up слоя аналогично, паддинг skip-connection, чтобы можно было нормально перекидывать из левой части в правую, это из того, что не было. Всё отдебажил дедовским способом - через вывод размерностей после каждого слоя, в итоге всё было волшебно, пока я не начал это дело учить. Вопрос был в том, куда там воткнуть диффузию. Я чё-то не сообразил, и воткнул её вообще везде. На генерации какая-то жижа \
<img src="https://media.discordapp.net/attachments/674191702906503199/1206416743757778956/image.png?ex=65dbee25&is=65c97925&hm=9a4223b196960d235f3f7496a1aa6382ad6c1ece0ceeefaff6d902cf15502ee3&=&format=webp&quality=lossless&width=600&height=345" width="500px"> \
В итоге я решил, что дело во мне и пошёл читать чат, где пояснили, что архитектуру трогать не надо. Ну я и вернул обратно. Единственное, что там тогда надо было поменять это размерность тайм эмбеддинга, а то он не бродкастится. И всё, тест проходится, но не всегда

- В самих тестах я косяков не обнаружил, если честно, по-моему они нормальные, либо я уже забыл. Так что их я не трогал

- Зато где ещё были проблемы, так это в процессе диффузии. Я тоже всё пометил, но вкратце - там были проблемы с мегадевайсом, но их тоже тест подсветил - тензоры на разных девайсах, соответственно валится форвард. И в формулах была ошибка, но там достаточно в статью посмотреть, чтобы исправить

- И сразу ещё добавил рандом флип в аугментации с `p=0.5`, чтобы было их примерно поровну. Это просили в части с гидрой, можно убрать из конфига, если не хочется

- Тест пайплайна пришлось делать хитро. На кеггле по какой-то причине cov не работает и неправильно всё считает, так что я пошёл опять в колаб. Нюанс ещё в том, что я к этому моменту уже добавил кучу всякого шлака, типа логгирования, сидов красивых и прочего, из-за чего файл немного больше, чем изначально, а coverage считается по строкам. Ну и прикол ещё в том, что зачем делать логи тестов в вандб я не знаю, хотя в целом можно, но я оффнул, потому что не смог пофиксить - вандб ругался на то, что я пытаюсь заходить в него без ключа от апи. Короче тест немного другой, чем я хотел изначально, но рабочий, пруфы лежат в `htmlcov` \
<img src="https://media.discordapp.net/attachments/674191702906503199/1206462566294093834/image.png?ex=65dc18d2&is=65c9a3d2&hm=4fc1ec202e89452d3c981e6af80b20ff22b3f479aa5622b139d7d13e961fc92b&=&format=webp&quality=lossless&width=925&height=191" width="500px"> \
И я проверял своими глазами через репорт, всё там покрывается, кроме логов, обидно /
<img src="https://media.discordapp.net/attachments/674191702906503199/1206463517020917790/image.png?ex=65dc19b5&is=65c9a4b5&hm=34c64257f23e78a695103a987c00f85bf99ff36c93bef949f9a05e51b21fd2ba&=&format=webp&quality=lossless&width=732&height=456" width="500px"> \


По итогу вроде всё рисуется, даже 100 эпох ждать не надо, но я сделал офк

[Wandb на 100 эпохах](https://wandb.ai/lerostre/edl_testing/runs/ubwyesqh?workspace=user-lerostre)

<img src="https://media.discordapp.net/attachments/674191702906503199/1206418090405924874/image.png?ex=65dbef66&is=65c97a66&hm=4c2030875f6a295b1b8db937a25967002964de7a963e348ea4e3c76cd4604a4b&=&format=webp&quality=lossless&width=581&height=330"> \

А ещё колаб не давал мне гпу на 2 аккаунтах сразу, поэтому я грузил всё на кегл, как же это неудобно

### 2. Гидра

Я на самом деле начал с гидры, чтобы было удобно эксперименты гонять. В целом там особых проблем не было, достаточно заменить всё в мейне на параметры из конфига. Я даже заморочился и сделал всё с датаклассами, но это была большая ошибка. Я так и не понял, как адекватно передать допустим разные оптимайзеры в конфиге, чтобы это было именно юзер-френдли. Можно сделать через костыль - передать строку, параметры, которые юзер думает, что там должны быть, через функцию вызвать нужный оптимайзер с нужными параметрами. Проблема в трансформах, потому что их много, параметры у них разные, прописывать это всё долго. Так что я решил тупо их прописать, как в питоне, ну а что делать... Ну и ещё там по мелочи какие-то проблемы, что итерабл нельзя просто так передать, что опциональных параметров там нет (вроде), конфиг на вандб ещё надо придумать, как грузить, но в целом чилл, это всё в `config.yaml` лежит и в `config_def.py`

### 3. Wandb

Вот это я тоже почти сразу пошёл делать. Там вообще никаких проблем не было, кроме того, что конфиг надо было прочитать в формате словаря, иначе некрасиво было на сайте, но это легко, сейчас там всё ништяк
<img src="https://cdn.discordapp.com/attachments/674191702906503199/1206420779571482644/image.png?ex=65dbf1e8&is=65c97ce8&hm=82213eb6d53b72d7a4632b65675dc44dd021f0b3f22cfc774b23e6edb4e7b99f&" width="500px">

Тут же я сделал [три](https://wandb.ai/lerostre/edl_testing/runs/8gn4zl0n?workspace=user-lerostre) [тестовых](https://wandb.ai/lerostre/edl_testing/runs/il7yapzv?workspace=user-lerostre) [запуска](https://wandb.ai/lerostre/edl_testing/runs/cvq1cygg?workspace=user-lerostre), чтобы проверить, что конфиг с гидрой работает. Взял просто разные lr, в одном случае, чтобы лосс скакал, в другом, чтобы обучения не было, это очень наглядно, и с супер маленьким семплом, чтобы обучение было быстрым. Они не полностью обучены, уже не хватает времени, но видно, что всё работает

Единственное, я не понял, какие инпуты нужно хранить. Зачем хранить картинки из трейна я не очень понимаю, но можно, правда это надо до аугментаций делать. Либо можно после, но до конверта в тензоры. Либо это должен быть шум, из которого мы сэмплим? Или вообще батч, который в трейн идёт? В общем, я не понял. Я сделал конечно, но это бесполезно как-то. Ну ладно, хотя бы знаю как

### 4. DVC

Вот тут я уже не успеваю сделать. Вроде бы там не сложно - достаточно вытащить логика загрузки датасета в отдельный файл, мейн можно оставить, как есть, только конфиг теперь можно считывать из файла. По большому счёту на семинаре уже было. Но не успеваю (

░░░░░░░░░░░░░░ \
░░░░▄▀▀▀▄░░░░░░░░ \
▄███▀░◐░▄▀▀▀▄░░░░░░ \
░░▄███▀░◐░░░░▌░░░ \
░░░▐░▄▀▀▀▄░░░▌░░░░ \
▄███▀░◐░░░▌░░▌░░░░ \
░░░░▌░░░░░▐▄▄▌░░░░░ \
░░░░▌░░░░▄▀▒▒▀▀▀▀▄ \
░░░▐░░░░▐▒▒▒▒▒▒▒▒▀▀▄ \
░░░▐░░░░▐▄▒▒▒▒▒▒▒▒▒▒▀▄ \
░░░░▀▄░░░░▀▄▒▒▒▒▒▒▒▒▒▒▀▄ \
░░░░░░▀▄▄▄▄▄█▄▄▄▄▄▄▄▄▄▄▄▀▄ \
░░░░░░░░░░░▌▌░▌▌░░░░░ \
░░░░░░░░░░░▌▌░▌▌░░░░░ \
░░░░░░░░░▄▄▌▌▄▌▌░░░░░ \